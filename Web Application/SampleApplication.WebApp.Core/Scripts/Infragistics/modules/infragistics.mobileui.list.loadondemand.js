/*
 * Infragistics.Web.MobileUI ListView LoadOnDemand 12.1.20121.1010
 *
 * Copyright (c) 2011-2012 Infragistics Inc.
 *
 * http://www.infragistics.com/
 *
 * Depends on:
 *  jquery-1.6.4.js
 *	jquery.ui.core.js
 *  ig.mobileui.list.js
 *	ig.dataSource.js
 *  ig.ui.shared.js
 *	ig.util.js
 */
(function(a){a.widget("mobile.igListViewLoadOnDemand",a.mobile.widget,{css:{loadMoreBtn:"ui-iglist-load-more"},options:{type:null,pageSize:10,recordCountKey:null,pageSizeUrlKey:null,pageIndexUrlKey:null,mode:"button",autoHideButtonAtEnd:true},events:{itemsRequesting:"itemsRequesting",itemsRequested:"itemsRequested"},_create:function(){this._maxPosition=0;this._lastItemCount=0},_setOption:function(c,d){a.Widget.prototype._setOption.apply(this,arguments);if(c==="type"){throw new Error(a.ig.Grid.locale.optionChangeNotSupported+" "+c)}},_locale:function(c){var d=this.options[c];if(d===undefined||d===null){d=a.ig.mobileListViewLoadOnDemand&&a.ig.mobileListViewLoadOnDemand.locale?a.ig.mobileListViewLoadOnDemand.locale[c]:null}return d||""},_footerRendering:function(d,c){var f=this,e;if(this.options.mode!=="button"){return}a("<div>").addClass(this.css.loadMoreBtn).text(this._locale("loadMoreItemsLabel")).bind("click",function(g){e=f._trigger(f.events.itemsRequesting,null,{owner:f,newPageIndex:f.list.dataSource.settings.paging.pageIndex+1});if(e){f._shouldFireItemsRequested=true;if(f.list.dataSource.pageIndex()<f.list.dataSource.pageCount()-1){a.mobile.showPageLoadingMsg()}f.list.dataSource.nextPage()}}).buttonMarkup({inline:false}).appendTo(c.footerContents)},_itemsRendering:function(d,c){c.index=this.list.dataSource.settings.paging.pageIndex*this.list.dataSource.settings.paging.pageSize;if(this._skippedDivider&&c.index>0){c.index--}if(this.list.options.inset){c.listElement.children().last().removeClass("ui-corner-bottom").find(".ui-btn-inner").not(".ui-li-link-alt span:first-child").removeClass("ui-corner-bottom").end().end().find(".ui-li-thumb").not(".ui-li-icon").removeClass("ui-corner-bl")}},_itemsRendered:function(h,e){var c,d,g,w,u=this,v,m=this.list,p=m.options,o,j=p._hParent,k=j.options,n,s,r,q,l,f,t;if(this.list.options.bindings&&this.list.options.bindings.isDividerKey&&this.list.dataSource.dataView().length>0){v=this.list.dataSource.dataView()[this.list.dataSource.dataView().length-1];if(v[this.list.options.bindings.isDividerKey]===true){this._skippedDivider=true}else{delete this._skippedDivider}}else{delete this._skippedDivider}if(this._shouldFireItemsRequested){if(this.options.autoHideButtonAtEnd&&this.list.dataSource.pageIndex()===this.list.dataSource.pageCount()-1){this.list.container().find("."+this.css.loadMoreBtn).hide();if(this.options.mode==="automatic"){a(document).unbind("scroll",this._docScrolledHandler);this._notBoundScroll=true}}o=parseInt(m.element.attr("data-level"),10);if(j&&(o<k.initialDataBindDepth||k.initialDataBindDepth===-1)){q=this.list.dataSource.settings.paging.pageIndex;if(o>0){n=p._parent;s=n.closest(".ig-listview").data("igFlatList").options;r=s._parent;t=j._getChildDataSource(s,p,n,r);f=j._hds.dataAt(t.itemId,t.keyspath+t.keyspathvar)}else{f=j._hds.root()}if(f&&(a.type(f)==="array"||(p.responseDataKey&&a.type(f[p.responseDataKey])==="array"))){for(l=q*m.dataSource.settings.paging.pageSize;l<m.dataSource._dataView.length;++l){if(p.responseDataKey){f[p.responseDataKey][l]=this.list.dataSource._dataView[l]}else{f[l]=this.list.dataSource._dataView[l]}}}}this._trigger(this.events.itemsRequested,null,{owner:this});this._shouldFireItemsRequested=false}else{if(this.options.autoHideButtonAtEnd&&this.list.dataSource.pageCount()<=1){this.list.container().find("."+this.css.loadMoreBtn).hide();if(this.options.mode==="automatic"){a(document).unbind("scroll",this._docScrolledHandler);this._notBoundScroll=true}}else{this.list.container().find("."+this.css.loadMoreBtn).show();if(this._notBoundScroll){a(document).bind("scroll",this._docScrolledHandler);delete this._notBoundScroll}}}a.mobile.hidePageLoadingMsg();if(this.options.mode==="automatic"&&this.list.dataSource.pageIndex()<this.list.dataSource.pageCount()-1&&(this._docScrolledFired||!this._loadedAfterRender)){c=a(document);g=c.height();d=a(window);w=d.height();if(g<=w){setTimeout(function(){var i;i=u._trigger(u.events.itemsRequesting,null,{owner:u,newPageIndex:u.list.dataSource.settings.paging.pageIndex+1});if(i){if(!this._docScrolledFired){this._loadedAfterRender=true}u._shouldFireItemsRequested=true;if(u.list.dataSource.pageIndex()<u.list.dataSource.pageCount()-1){a.mobile.showPageLoadingMsg()}u.list.dataSource.nextPage();a.mobile.hidePageLoadingMsg()}})}}if(this.list.dataSource.dataView().length<this._lastItemCount){this._maxPosition=0}this._lastItemCount=this.list.dataSource.dataView().length},_docScrolled:function(e){var i=false,c=a(window),k=c.height(),j=c.scrollTop(),g=this.list.listElement.children().last(),f=g.offset(),d=a.mobile.activePage,h=this.list.element.closest(".ui-page");this._docScrolledFired=true;if(this._loadedAfterRender){delete this._loadedAfterRender;return}if(d&&d[0]===h[0]&&this._maxPosition<k+j&&f&&(f.top-g.outerHeight())<=k+j&&!this._shouldFireItemsRequested){i=this._trigger(this.events.itemsRequesting,null,{owner:this,newPageIndex:this.list.dataSource.settings.paging.pageIndex+1});if(i){if(this.list.dataSource.pageIndex()<this.list.dataSource.pageCount()-1){a.mobile.showPageLoadingMsg();this._shouldFireItemsRequested=true}this._maxPosition=k+j;this.list.dataSource.nextPage()}}},_createHandlers:function(){this._footerRendering=a.proxy(this._footerRendering,this);this._itemsRenderingHandler=a.proxy(this._itemsRendering,this);this._itemsRenderedHandler=a.proxy(this._itemsRendered,this);if(this.options.mode==="automatic"){this._docScrolledHandler=a.proxy(this._docScrolled,this)}},_registerEvents:function(){this.list.element.bind("iglistfooterrendering",this._footerRendering);this.list.element.bind("iglistitemsrendering",this._itemsRenderingHandler);this.list.element.bind("iglistitemsrendered",this._itemsRenderedHandler);if(this.options.mode==="automatic"){a(document).bind("scroll",this._docScrolledHandler)}},_unregisterEvents:function(){this.list.element.unbind("iglistfooterrendering",this._footerRendering);this.list.element.unbind("iglistitemsrendering",this._itemsRenderingHandler);this.list.element.unbind("iglistitemsrendered",this._itemsRenderedHandler);if(this.options.mode==="automatic"){a(document).unbind("scroll",this._docScrolledHandler)}delete this.footerRendering;delete this._itemsRenderingHandler;delete this._itemsRenderedHandler;delete this._docScrolledHandler},_injectList:function(d,c){this.list=d;if(this.options.type===null){this.options.type=this.list._inferOpType()}if(this.options.type){this.list.dataSource.settings.paging.type=this.options.type}else{this.list.dataSource.settings.paging.type="remote"}this.list.dataSource.settings.paging.enabled=true;if(this.options.pageSizeUrlKey){this.list.dataSource.settings.paging.pageSizeUrlKey=this.options.pageSizeUrlKey}if(this.options.pageIndexUrlKey){this.list.dataSource.settings.paging.pageIndexUrlKey=this.options.pageIndexUrlKey}if(this.options.recordCountKey!==null){this.list.dataSource.settings.responseTotalRecCountKey=this.options.recordCountKey}this.list.dataSource.settings.paging.pageSize=this.options.pageSize;this.list.dataSource.settings.paging.pageIndex=0;this.list.dataSource.settings.paging.appendPage=true;this.list._loadOnDemand=true;this._createHandlers();this._registerEvents()},destroy:function(){this._unregisterEvents();if(this.options.mode==="button"){this.list.container().find("."+this.css.loadMoreBtn).remove()}delete this.list._loadOnDemand;delete this._docScrolledFired;this.list._requireRecordsClear=true;delete this._notBoundScroll;this.list.dataSource.settings.paging.enabled=false;this.list.dataSource.settings.paging.pageIndex=0;if(this.options.type==="local"){this.list.dataSource.pageSize(this.list.dataSource._data.length)}else{this.list.dataSource.dataBind()}a.Widget.prototype.destroy.call(this);return this}});function b(d){return"-"+d.toLowerCase()}a(document).bind("_igListViewHtmlOptions",function(e,c){var d=c.element,f,g,h;if(d.jqmData("load-on-demand")===true){if(!c.options.features){c.options.features=[]}f=c.options.features[c.options.features.length]={};f.name="LoadOnDemand";for(g in a.mobile.igListViewLoadOnDemand.prototype.options){if(a.mobile.igListViewLoadOnDemand.prototype.options.hasOwnProperty(g)){h=d.jqmData("load-on-demand-"+g.replace(/[A-Z]/g,b));if(h!==undefined){f[g]=h}}}}});if(typeof define==="function"&&define.amd&&define.amd.jQuery){define("ig.mobileui.list.loadondemand",["ig.mobileui.list"],function(){return a.mobile.igListViewLoadOnDemand})}a.extend(a.mobile.igListViewLoadOnDemand,{version:"12.1.20121.1010"})}(jQuery));